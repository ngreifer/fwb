<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Reproducibility and Parallelization with `fwb` • fwb</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Reproducibility and Parallelization with `fwb`">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">fwb</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.0.9001</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/fwb-rep.html">Reproducibility and Parallelization with `fwb`</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ngreifer/fwb/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Reproducibility and Parallelization with `fwb`</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ngreifer/fwb/blob/master/vignettes/fwb-rep.Rmd" class="external-link"><code>vignettes/fwb-rep.Rmd</code></a></small>
      <div class="d-none name"><code>fwb-rep.Rmd</code></div>
    </div>

    
    
<p>Reproducibility ensures re-running the same analysis yields identical
results. Because a random process is involved in generating the
bootstrap weights with <code><a href="../reference/fwb.html">fwb::fwb()</a></code>, steps must be taken to
ensure reproducibility is possible.</p>
<p>There are a few arguments to <code><a href="../reference/fwb.html">fwb()</a></code> that are relevant for
reproducibility. These are <code>statistic</code>, <code>simple</code>,
and <code>cl</code>.</p>
<ul>
<li><p><code>statistic</code> is the function that is applied to each
bootstrap dataset and returns the quantities of interest to be
estimated. It can either have a random component or not; each case
requires special attention. It is always safer to avoid having a random
component in <code>statistic</code>. Most common regression functions to
do not involve a random component, but some advanced models, like
machine learning models, may. Do not ever include a call to
<code><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed()</a></code> or supply a seed to <code>statistic</code>. If
you are using parallelization for <code><a href="../reference/fwb.html">fwb()</a></code>, do not use
parallelization within <code>statistic</code>.</p></li>
<li><p><code>simple</code> controls whether the bootstrap weights are
generated all at once (<code>simple = FALSE</code>) or generated
separately within each bootstrap iteration (<code>simple = TRUE</code>).
When <code>simple = FALSE</code>, the weights are generated before any
parallelization takes place or <code>statistic</code> is called, which
makes ensuring reproducibility more straightforward. When
<code>simple = TRUE</code>, the weights are generated before the call to
<code>statistic</code> in each bootstrap iteration, which can make it a
bit more challenging to ensure reproducibility when using
parallelization and adds even more challenges when
<code>statistic</code> also has a random component.</p></li>
<li><p><code>cl</code> controls whether and how parallelization takes
place. It is passed directly to <code><a href="https://rdrr.io/pkg/pbapply/man/pbapply.html" class="external-link">pbapply::pblapply()</a></code>, which
calls either <code><a href="https://rdrr.io/r/parallel/mclapply.html" class="external-link">parallel::mclapply()</a></code>,
<code><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">parallel::parLapply()</a></code>, or
<code><a href="https://future.apply.futureverse.org/reference/future_lapply.html" class="external-link">future.apply::future_lapply()</a></code>, depending on how it is
specified. The usual arguments include an integer referring to the
number of cores, which only works on Mac and triggers
<code><a href="https://rdrr.io/r/parallel/mclapply.html" class="external-link">parallel::mclapply()</a></code>; a <code>cluster</code> object
(usually the result of a call to <code><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">parallel::makeCluster()</a></code> or
related functions), which triggers <code><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">parallel::parLapply()</a></code>;
or <code>"future"</code>, which uses a <code>future</code> backend
(usually initialized using <code><a href="https://future.futureverse.org/reference/plan.html" class="external-link">future::plan()</a></code>). Each of these
involves different requirements for ensuring reproducibility.</p></li>
</ul>
<p>This guide will proceed for combinations of these scenarios.</p>
<div class="section level3">
<h3 id="case-1-no-parallelization-cl-null">Case 1: No parallelization (<code>cl = NULL</code>)<a class="anchor" aria-label="anchor" href="#case-1-no-parallelization-cl-null"></a>
</h3>
<p>When no parallelization is used (i.e., <code>cl</code> is
unspecified, <code>NULL</code>, or <code>1</code>), all you need to do
is call <code><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed()</a></code> before <code><a href="../reference/fwb.html">fwb()</a></code> to ensure
reproducibility. It doesn’t matter what <code>simple</code> or
<code>statistic</code> do. This is probably the most common case. Just
run the following to ensure reproducibility, replacing <code>{N}</code>
with your favorite integer.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="op">{</span><span class="va">N</span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">f.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fwb.html">fwb</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="case-2-simple-false-non-random-statistic">Case 2: <code>simple = FALSE</code>, non-random
<code>statistic</code><a class="anchor" aria-label="anchor" href="#case-2-simple-false-non-random-statistic"></a>
</h3>
<p>If <code>simple = FALSE</code> and <code>statistic</code> does not
have a random component, see Case 1, regardless of whether or how
parallelization is used. In this case, no random process occurs within
each cluster, so no special steps need to be taken beyond setting a
seed. Note that <code>simple</code> is <code>TRUE</code> by default
unless <code>wtype = "multinom"</code>, so this must be set manually.
See below for a code example:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="op">{</span><span class="va">N</span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">f.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fwb.html">fwb</a></span><span class="op">(</span><span class="va">.</span>, simple <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="case-3-cl-is-an-integer">Case 3: <code>cl</code> is an integer<a class="anchor" aria-label="anchor" href="#case-3-cl-is-an-integer"></a>
</h3>
<p>When <code>cl</code> is an integer and the criteria for Case 2 are
not met (i.e., <code>simple = TRUE</code> or <code>statistic</code> has
a random component), one additional step is required for ensuring
reproducibility. Again, all you need to do is use
<code><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed()</a></code>, but you must call it with
<code>kind = "L'Ecuyer-CMRG"</code>, which is the only method
appropriate for use across multiple clusters. See below for a code
example:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="op">{</span><span class="va">N</span><span class="op">}</span>, <span class="st">"L'Ecuyer-CMRG"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">f.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fwb.html">fwb</a></span><span class="op">(</span><span class="va">.</span>, cl <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="case-4-cl-is-future">Case 4: <code>cl</code> is <code>"future"</code><a class="anchor" aria-label="anchor" href="#case-4-cl-is-future"></a>
</h3>
<p>When using a <code>future</code> backend and the criteria for Case
are not met, you can use the same solution as for Case 3.
<code><a href="../reference/fwb.html">fwb()</a></code> performs an additional step to make sure the seed is
correctly sent to <code><a href="https://future.apply.futureverse.org/reference/future_lapply.html" class="external-link">future.apply::future_lapply()</a></code>.
(Internally, this works by setting <code>future.seed = TRUE</code>,
which you should not do yourself.) See below for a code example:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="op">{</span><span class="va">N</span><span class="op">}</span>, <span class="st">"L'Ecuyer-CMRG"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">f.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fwb.html">fwb</a></span><span class="op">(</span><span class="va">.</span>, cl <span class="op">=</span> <span class="st">"future"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="case-5-cl-is-a-cluster-object">Case 5: <code>cl</code> is a <code>cluster</code> object<a class="anchor" aria-label="anchor" href="#case-5-cl-is-a-cluster-object"></a>
</h3>
<p>When <code>cl</code> is a <code>cluster</code> object (i.e., the
output of a call to <code><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">parallel::makeCluster()</a></code>,
<code><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">parallel::makePSOCKcluster()</a></code>,
<code><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">parallel::makeForkCluster()</a></code> or similar functions in
<em>parallelly</em>), an additional step must be taken to ensure
reproducibility. Unfortunately, you can’t use <code><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed()</a></code>;
you have to use <code><a href="https://rdrr.io/r/parallel/RngStream.html" class="external-link">parallel::clusterSetRNGStream()</a></code>, to which
you supply the <code>cluster</code> object and your desired seed. See
below for a code example:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/RngStream.html" class="external-link">clusterSetRNGStream</a></span><span class="op">(</span><span class="va">cl</span>, <span class="op">{</span><span class="va">N</span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">f.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fwb.html">fwb</a></span><span class="op">(</span><span class="va">.</span>, cl <span class="op">=</span> <span class="va">cl</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="computing-bca-confidence-intervals">Computing BCa confidence intervals<a class="anchor" aria-label="anchor" href="#computing-bca-confidence-intervals"></a>
</h2>
<p>Although the main purpose of considering reproducibility is to ensure
that multiple runs of the same code produce identical results, there is
another situation in which it can be important to be able to reproduce
the weights, and that is when computing bias-corrected accelerated (BCa)
confidence intervals using <code>fwb.ci(., type = "bca")</code> or
<code>summary(., ci.type = "bca")</code>. BCa confidence intervals have
the best statistical properties among the available bootstrap confidence
intervals, but they require computing the influence each unit has on the
bootstrap estimates, which requires re-generating the weights as they
were generated by <code><a href="../reference/fwb.html">fwb()</a></code>.</p>
<p>There are some cases where you don’t have to do any special work to
ensure BCa intervals are correctly computed. These include:</p>
<ul>
<li>
<code>simple = FALSE</code>, regardless of parallelization or
randomness in <code>statistic</code>
</li>
<li>
<code>simple = TRUE</code>, there is no randomness in
<code>statistic</code>, and no parallelization is used</li>
<li>
<code>simple = TRUE</code>, there is no randomness in
<code>statistic</code>, and <code>cl</code> is an integer or
<code>"future"</code>
</li>
</ul>
<p>In these cases, <code><a href="../reference/fwb.html">fwb()</a></code> saves the state of the random seed
that was used to originally generate the weights, and
<code><a href="../reference/fwb.ci.html">fwb.ci()</a></code> recalls that seed to re-generate the weights and
then computes the required statistics for the BCa interval without
requiring any extra involvement by the user.</p>
<p>Otherwise, when the following condition is met, an additional step is
required:</p>
<ul>
<li>
<code>simple = TRUE</code>, there is no randomness in
<code>statistic</code>, and <code>cl</code> is a <code>cluster</code>
object</li>
</ul>
<p>In this case, you need to call
<code>parallel::clusterSetRNGStream(cl, {N})</code> with the same seed
as as was used prior to <code><a href="../reference/fwb.html">fwb()</a></code> immediately before calling
<code><a href="../reference/fwb.ci.html">fwb.ci()</a></code> or <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code>.</p>
<p>When <code>simple = TRUE</code> and there is any randomness in
<code>statistic</code>, it is not possible to re-generate the weights
that were used in the bootstrap, so BCa confidence intervals cannot be
computed. <code><a href="../reference/fwb.ci.html">fwb.ci()</a></code> (and <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> and
<code><a href="https://rdrr.io/r/stats/confint.html" class="external-link">confint()</a></code>, which call <code><a href="../reference/fwb.ci.html">fwb.ci()</a></code>) automatically
checks for this case and throws an error if BCa confidence intervals are
requested when these conditions are met.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Noah Greifer.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
